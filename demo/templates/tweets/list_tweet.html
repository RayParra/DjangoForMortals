{% extends "base.html" %}

{% block title %}ListTweet{% endblock %}

{% block script %}
	<script type="text/javascript">
		function getParameterByName(name, url) {
    		if (!url) url = window.location.href;
    			name = name.replace(/[\[\]]/g, '\\$&');
    		var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        	results = regex.exec(url);
    		if (!results) return null;
    		if (!results[2]) return '';
    		return decodeURIComponent(results[2].replace(/\+/g, ' '));
		}


		$(document).ready(function(){
			console.log("Working");
		
		var query = getParameterByName('q')
			//console.log(query)
			var tweetList = []
			

		function attachTweet(tweetValue, prepend){
			var tweetUser = tweetValue.user
			var tweetContent = tweetValue.content
			var tweetDateDisplay = tweetValue.date_display

			var tweetFormatedHtml = "<div class=\"media\"> <img class=\"mr-3\" src=\".../64x64\" alt=\"UserImage\"><div class=\"media-body\"> <h5 class=\"mt-0\">" + tweetUser.username + " <br></h5>" + tweetContent + "<small> Publicated: |" + tweetDateDisplay + "| ago | <a href=\"#\">view</a><br></small> </div> </div> <hr>"
			if (prepend==true) {
				$("#tweet-container").prepend(tweetFormatedHtml)
			}
			else{
				$("#tweet-container").append(tweetFormatedHtml)	
			}
			
		}


		function parseTweets(){
			if (tweetList == 0){
				$("#tweet-container").text("Not Tweet Found")
			}
			else{
				$.each(tweetList, function(key, value){
					//console.log(key)
					//console.log(value.user)
					//console.log(value.content)
					var tweetKey = key;
					
					attachTweet(value)
					
					})

				}
			}

		function fetchTweet(){
				$.ajax({
					url: "/api/tweet/",
					method: "GET",
					data: {"q": query},

				success: function(data){
					//console.log(data)
					tweetList = data
					parseTweets()

					},
				
				error: function(data){
					console.log("error")
					console.log(data)
					}
				})

			}

			fetchTweet()

			$("#tweet-form").submit(function(event){
				event.preventDefault()
				var this_ = $(this)
				//console.log(event)
				//console.log(this_)
				var formData = this_.serialize()
				//fetchTweet()

				$.ajax({
				 	url: "/api/tweet/create/",
				 	data: formData,
				 	method: "POST",
				 	success: function(data){
				 		this_.find("input[type=text],textarea").val("")
				 		//console.log(data)
				 		//fetchTweet()
				 		attachTweet(data,true)
				 	},
			 	error: function(data){
			 		console.log("error")
			 		console.log(data.statusText)
					console.log(data.status)
			 	}
		 })
		})	
		
	});

		
	</script>
{% endblock %}

{% block content %}

			{% if not request.GET.p %}
				<div class="">
					{% include "tweets/form_create.html" with form=create_form action_url=create_url btn_title="Tweet" form_id="tweet-form"%}	
				</div>
			{% endif %}
		<hr>

<div id="tweet-container">
	
</div>

			
{% endblock %}

